<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Управління категоріями</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal">
        <i class="fas fa-plus"></i> Додати категорію
    </button>
</div>

<% if (error) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<% } %>

<% if (success) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= success %>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
<% } %>


<div class="table-responsive">
    <table class="table table-striped table-hover" id="categoriesTable">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Зображення</th>
                <th>Назва</th>
                <th>Опис</th>
                <th>Батьківська категорія</th>
                <th>Товарів</th>
                <th>Порядок</th>
                <th>Статус</th>
                <th>Дії</th>
            </tr>
        </thead>
        <tbody>
            <% categories.forEach(category => { %>
                <tr data-category-id="<%= category.id %>" class="<%= category.active ? '' : 'table-secondary' %>">
                    <td><%= category.id %></td>
                    <td>
                        <% if (category.image_url) { %>
                            <img src="<%= category.image_url %>" alt="<%= category.name %>" class="category-thumbnail" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                        <% } else { %>
                            <div class="bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 4px;">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        <% } %>
                    </td>
                    <td>
                        <strong><%= category.name %></strong>
                    </td>
                    <td>
                        <span class="text-muted"><%= category.description || '-' %></span>
                    </td>
                    <td>
                        <% if (category.parent_id) { %>
                            <% const parent = categories.find(c => c.id === category.parent_id) %>
                            <% if (parent) { %>
                                <span class="badge bg-info"><%= parent.name %></span>
                            <% } else { %>
                                <span class="text-muted">ID: <%= category.parent_id %></span>
                            <% } %>
                        <% } else { %>
                            <span class="badge bg-primary">Головна</span>
                        <% } %>
                    </td>
                    <td>
                        <span class="product-count" data-category-id="<%= category.id %>">-</span>
                    </td>
                    <td>
                        <span class="badge bg-secondary"><%= category.sort_order || 0 %></span>
                    </td>
                    <td>
                        <% if (category.active) { %>
                            <span class="badge bg-success">Активна</span>
                        <% } else { %>
                            <span class="badge bg-danger">Неактивна</span>
                        <% } %>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary edit-category" 
                                    data-category-id="<%= category.id %>" 
                                    title="Редагувати">
                                <i class="fas fa-edit me-1"></i>Редагувати
                            </button>
                            <button type="button" class="btn btn-outline-danger delete-category" 
                                    data-category-id="<%= category.id %>" 
                                    data-category-name="<%= category.name %>"
                                    title="Видалити">
                                <i class="fas fa-trash me-1"></i>Видалити
                            </button>
                        </div>
                    </td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<% if (categories.length === 0) { %>
    <div class="text-center py-5">
        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Немає категорій</h5>
        <p class="text-muted">Додайте першу категорію для початку</p>
    </div>
<% } %>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Додати категорію</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="categoryForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="categoryId" name="categoryId">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="categoryName" class="form-label">Назва категорії *</label>
                                <input type="text" class="form-control" id="categoryName" name="name" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="categoryDescription" class="form-label">Опис</label>
                                <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="parentCategory" class="form-label">Батьківська категорія</label>
                                        <select class="form-select" id="parentCategory" name="parent_id">
                                            <option value="">Головна категорія</option>
                                            <% categories.filter(c => c.active).forEach(category => { %>
                                                <option value="<%= category.id %>"><%= category.name %></option>
                                            <% }); %>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="sortOrder" class="form-label">Порядок сортування</label>
                                        <input type="number" class="form-control" id="sortOrder" name="sort_order" value="0" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="categoryActive" name="active" checked>
                                    <label class="form-check-label" for="categoryActive">
                                        Активна категорія
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="categoryImage" class="form-label">Зображення</label>
                                <input type="file" class="form-control" id="categoryImage" name="image" accept="image/*">
                                <div class="form-text">JPG, PNG, GIF до 5MB</div>
                            </div>
                            
                            <div class="text-center">
                                <div id="imagePreview" class="border rounded p-3" style="display: none;">
                                    <img id="previewImage" src="" alt="Preview" class="img-fluid" style="max-height: 150px;">
                                </div>
                                <div id="noImagePreview" class="border rounded p-3 text-muted">
                                    <i class="fas fa-image fa-2x mb-2"></i>
                                    <br>
                                    <small>Попередній перегляд</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none" id="submitSpinner"></span>
                        Зберегти
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Підтвердження видалення</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Ви впевнені, що хочете видалити категорію <strong id="deleteCategory"></strong>?</p>
                <p class="text-danger">Цю дію неможливо скасувати.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Скасувати</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Видалити</button>
            </div>
        </div>
    </div>
</div>

<script>
let categoriesDataTable;

document.addEventListener('DOMContentLoaded', function() {
    loadProductCounts();
    initDataTable();
    initCategoryManagement();
});

function initDataTable() {
    if (typeof $.fn.DataTable === 'undefined') {
        console.warn('DataTables library not loaded');
        return;
    }
    
    categoriesDataTable = $('#categoriesTable').DataTable({
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        order: [[0, 'desc']],
        columnDefs: [
            { orderable: false, targets: [1, 8] }, // Image and Actions columns
            { searchable: false, targets: [1, 8] }
        ],
        language: {
            search: "Пошук категорій:",
            lengthMenu: "Показати _MENU_ категорій на сторінці",
            info: "Показано _START_ до _END_ з _TOTAL_ категорій",
            infoEmpty: "Категорії не знайдені",
            infoFiltered: "(відфільтровано з _MAX_ загальних категорій)",
            zeroRecords: "Немає категорій для відображення",
            emptyTable: "Немає даних у таблиці",
            paginate: {
                first: "Перша",
                last: "Остання", 
                next: "Наступна",
                previous: "Попередня"
            },
            processing: "Обробка...",
            loadingRecords: "Завантаження записів..."
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>t<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        responsive: true
    });
}

function loadProductCounts() {
    const productCountElements = document.querySelectorAll('.product-count');
    productCountElements.forEach(element => {
        const categoryId = element.dataset.categoryId;
        fetch(`/admin/categories/${categoryId}/products-count`)
            .then(response => response.json())
            .then(data => {
                element.textContent = data.count || 0;
            })
            .catch(error => {
                console.error('Error loading product count:', error);
                element.textContent = '?';
            });
    });
}

function initCategoryManagement() {
    const categoryModal = new bootstrap.Modal(document.getElementById('categoryModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const categoryForm = document.getElementById('categoryForm');
    const imageInput = document.getElementById('categoryImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const noImagePreview = document.getElementById('noImagePreview');
    
    // Image preview
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                imagePreview.style.display = 'block';
                noImagePreview.style.display = 'none';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
            noImagePreview.style.display = 'block';
        }
    });
    
    // Add category
    document.querySelector('[data-bs-target="#categoryModal"]').addEventListener('click', function() {
        resetForm();
        document.getElementById('categoryModalTitle').textContent = 'Додати категорію';
    });
    
    // Edit category - Use event delegation for DataTables
    $(document).on('click', '.edit-category', function() {
        const categoryId = this.dataset.categoryId;
        loadCategoryForEdit(categoryId);
    });
    
    // Delete category - Use event delegation for DataTables
    $(document).on('click', '.delete-category', function() {
        const categoryId = this.dataset.categoryId;
        const categoryName = this.dataset.categoryName;
        document.getElementById('deleteCategory').textContent = categoryName;
        document.getElementById('confirmDelete').dataset.categoryId = categoryId;
        deleteModal.show();
    });
    
    // Confirm delete
    document.getElementById('confirmDelete').addEventListener('click', function() {
        const categoryId = this.dataset.categoryId;
        deleteCategory(categoryId);
    });
    
    // Form submit
    categoryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitCategoryForm();
    });
}

function resetForm() {
    document.getElementById('categoryForm').reset();
    document.getElementById('categoryId').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('noImagePreview').style.display = 'block';
}

function loadCategoryForEdit(categoryId) {
    fetch(`/admin/categories/api/${categoryId}`)
        .then(response => response.json())
        .then(category => {
            document.getElementById('categoryModalTitle').textContent = 'Редагувати категорію';
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
            document.getElementById('parentCategory').value = category.parent_id || '';
            document.getElementById('sortOrder').value = category.sort_order || 0;
            document.getElementById('categoryActive').checked = category.active;
            
            if (category.image_url) {
                document.getElementById('previewImage').src = category.image_url;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('noImagePreview').style.display = 'none';
            }
            
            new bootstrap.Modal(document.getElementById('categoryModal')).show();
        })
        .catch(error => {
            console.error('Error loading category:', error);
            alert('Помилка завантаження категорії');
        });
}

function submitCategoryForm() {
    const formData = new FormData(document.getElementById('categoryForm'));
    const categoryId = document.getElementById('categoryId').value;
    const isEdit = categoryId !== '';
    
    const spinner = document.getElementById('submitSpinner');
    spinner.classList.remove('d-none');
    
    const url = isEdit ? `/admin/categories/${categoryId}` : '/admin/categories';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => {
        if (isEdit) {
            return response.json();
        } else {
            return response.text();
        }
    })
    .then(data => {
        spinner.classList.add('d-none');
        if (isEdit) {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error updating category');
            }
        } else {
            location.reload();
        }
    })
    .catch(error => {
        spinner.classList.add('d-none');
        console.error('Error:', error);
        alert('Error saving category');
    });
}

function deleteCategory(categoryId) {
    fetch(`/admin/categories/${categoryId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ permanent: 'true' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('deleteModal').querySelector('.btn-close').click();
            
            // Remove row from DataTable
            const row = $(`tr[data-category-id="${categoryId}"]`);
            if (categoriesDataTable) {
                categoriesDataTable.row(row).remove().draw();
            } else {
                row.fadeOut(300, function() {
                    $(this).remove();
                });
            }
            
            showAlert('success', 'Категорію успішно видалено');
        } else {
            alert(data.error || 'Помилка видалення категорії');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Помилка видалення категорії');
    });
}

function showAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.alert').remove();
    $('.d-flex.justify-content-between').after(alertHtml);
}

</script>